# 企业级Web应用安全基线模板
# 适用于：Web服务器、API服务、微服务等

apiVersion: v1
kind: Pod
metadata:
  name: web-application-baseline
  labels:
    baseline: web-application
  annotations:
    description: "Enterprise security baseline for web applications"
spec:
  # Pod级别安全上下文
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 3000
    fsGroup: 2000
    seccompProfile:
      type: RuntimeDefault
    # 可选：SELinux/AppArmor
    # seLinuxOptions:
    #   level: "s0:c123,c456"

  containers:
    - name: app
      image: myapp:latest

      # Container级别安全上下文
      securityContext:
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        runAsNonRoot: true
        runAsUser: 1000
        capabilities:
          drop:
            - ALL
          # 根据应用需求添加必要的capabilities
          # add:
          # - NET_BIND_SERVICE  # 如果需要绑定<1024端口

      # 资源限制（必须配置）
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi

      # 健康检查
      livenessProbe:
        httpGet:
          path: /healthz
          port: 8080
        initialDelaySeconds: 30
        periodSeconds: 10
        timeoutSeconds: 5
        failureThreshold: 3

      readinessProbe:
        httpGet:
          path: /ready
          port: 8080
        initialDelaySeconds: 10
        periodSeconds: 5
        timeoutSeconds: 3
        failureThreshold: 2

      # 只读文件系统需要的可写目录
      volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: cache
          mountPath: /app/cache
        - name: logs # 如果需要本地日志（建议使用stdout）
          mountPath: /app/logs

  volumes:
    - name: tmp
      emptyDir:
        sizeLimit: 100Mi
    - name: cache
      emptyDir:
        sizeLimit: 500Mi
    - name: logs
      emptyDir:
        sizeLimit: 1Gi

---
# Pod Security Standard: Restricted
# 为namespace应用此标准
apiVersion: v1
kind: Namespace
metadata:
  name: production
  labels:
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
